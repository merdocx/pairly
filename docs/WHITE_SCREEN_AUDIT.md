# Аудит: белый экран при навигации

## Связь с «Запомнить меня»

**«Запомнить меня» не является причиной белого экрана.**

Изменения при внедрении чекбокса:
- **Бэкенд**: в `auth.ts` добавлены `remember_me` в схему и разный `maxAge` cookie (30 дней / 24 часа). Остальное (path, sameSite, httpOnly) не менялось.
- **Фронтенд**: чекбокс на логине/регистрации, отправка `remember_me` в теле запроса, стили для `.form-field-checkbox` и `input:not([type="checkbox"])`.

Cookie задаётся один раз при логине; при переходах между страницами только отправляется в запросах (`credentials: 'include'`). Никакой логики навигации или рендера это не затрагивает. Белый экран появлялся из‑за навигации/React, а не из‑за cookie.

## Реальные причины белого экрана

1. **useSearchParams() без гарантированного Suspense**  
   В Next.js App Router вызов `useSearchParams()` может приостанавливать рендер до появления search params. Если компонент с `useSearchParams` не обёрнут в Suspense, при клиентском переходе возможен «пустой» кадр или зависание.
   - **Главная**: `HomePageContent` использует `useSearchParams` и обёрнут в `Suspense` в `HomePage` — ок.
   - **Фильм**: `MoviePage` использует `useSearchParams`; корневой layout оборачивает `children` в `Suspense` с fallback — ок.
   - **BottomNav**: раньше использовал `useSearchParams`; вызов убран, остаётся только `usePathname` — ок.

2. **Полный размонт при смене маршрута (key={pathname})**  
   В `PageTransition` раньше стоял `key={pathname}`. При каждом переходе всё дерево размонтировалось и монтировалось заново, что могло давать белый кадр. Key убран — переходы без полного размонта.

3. **Нет loading/error UI при переходах**  
   Пока подгружался новый сегмент или падал рендер, пользователь видел пустой экран. Добавлены:
   - `app/loading.tsx` — показ при загрузке сегмента (в т.ч. при навигации);
   - `app/error.tsx` — перехват ошибок рендера страницы;
   - `NavigationProgress` — краткий индикатор «Загрузка…» при смене pathname;
   - Suspense fallback в корневом layout.

## Текущие меры (что должно предотвращать белый экран)

| Механизм | Назначение |
|----------|------------|
| `app/loading.tsx` | Показ при загрузке страницы/сегмента при навигации |
| `app/error.tsx` | Перехват ошибок рендера страницы, показ сообщения вместо пустого экрана |
| `NavigationProgress` | Показ «Загрузка…» минимум 200 ms при смене pathname |
| Layout Suspense | Fallback «Загрузка…» при suspend (в т.ч. useSearchParams) |
| Без key в PageTransition | Нет полного размонта при переходе |
| BottomNav без useSearchParams | Нет лишнего suspend в навигации |

## Рекомендации

- Любой компонент, использующий `useSearchParams()`, должен быть внутри Suspense (как в корневом layout для всех страниц).
- Не использовать `key={pathname}` (или аналог) на обёртке всего контента страницы — это провоцирует полный размонт при каждом переходе.
- После изменений в навигации или layout проверять переходы: главная ↔ поиск ↔ профиль ↔ страница фильма.
