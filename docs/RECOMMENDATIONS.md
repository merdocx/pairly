# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —Ç–µ—Å—Ç—ã

**–î–∞—Ç–∞:** 28.01.2026  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** 0.3.0  
**–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑:** —É–≥–ª—É–±–ª—ë–Ω–Ω—ã–π, —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –°–¥–µ–ª–∞–Ω–æ

- **Rate limiting** ‚Äî –≤–∫–ª—é—á—ë–Ω `express-rate-limit`: auth 20 –∑–∞–ø—Ä–æ—Å–æ–≤/15 –º–∏–Ω, API 120/–º–∏–Ω. –û—Ç–≤–µ—Ç 429 –≤ JSON.
- **Helmet** ‚Äî –≤–∫–ª—é—á—ë–Ω —Å `crossOriginResourcePolicy: 'cross-origin'`, CSP –æ—Ç–∫–ª—é—á—ë–Ω –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å–æ —Å–∫—Ä–∏–ø—Ç–∞–º–∏/—Å—Ç–∏–ª—è–º–∏.
- **–í–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî –≤ movies —Ä–æ—É—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ `AppError` –≤ `next(e)`, —á—Ç–æ–±—ã 400 –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–ª–∏—Å—å –≤ 502.

### –ö—Ä–∏—Ç–∏—á–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ø—Ä–æ–¥–µ)

- **JWT_SECRET** ‚Äî –≤ –∫–æ–¥–µ –µ—Å—Ç—å fallback `'dev-secret-change-in-production'`. –í –ø—Ä–æ–¥–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å —Å–≤–æ–π –¥–ª–∏–Ω–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π `JWT_SECRET` –≤ `.env`.
- **CORS** ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ –ø—Ä–æ–¥–µ `WEB_ORIGIN` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `*`, –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–æ–º–µ–Ω—ã.

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ

- **–¢–æ–∫–µ–Ω –≤ localStorage** ‚Äî –ø—Ä–∏ XSS —Ç–æ–∫–µ–Ω –º–æ–∂–Ω–æ —É–∫—Ä–∞—Å—Ç—å. –ë–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ: httpOnly cookie —Å secure –≤ HTTPS (–ø–æ—Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ –±—ç–∫–µ–Ω–¥–µ –∏ —Ñ—Ä–æ–Ω—Ç–µ).
- **–í–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ query/params/body (Zod) –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 400 –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –í watchlist `sort` –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–≤—É–º—è –≤–µ—Ç–∫–∞–º–∏ –≤ –∫–æ–¥–µ ‚Äî SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ –Ω–µ—Ç.

---

## 2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑)

### 2.1 –ë—ç–∫–µ–Ω–¥: Watchlist –∏ N+1

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**

- **GET /api/watchlist/me** ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ —Å–ø–∏—Å–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `getMovieDetail(movie_id)`. –ü—Ä–∏ 50 —Ñ–∏–ª—å–º–∞—Ö: –¥–æ 50 –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ Redis (–∏–ª–∏ TMDB –ø—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ). Redis –∫—ç—à–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª–∏ –Ω–∞ 24 —á ‚Äî –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –ø—Ä–æ–º–∞—Ö–æ–≤ –º–µ–Ω—å—à–µ, –Ω–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ —Ç—è–∂—ë–ª—ã–π.
- **GET /api/watchlist/partner** ‚Äî —Ç–æ –∂–µ: N –≤—ã–∑–æ–≤–æ–≤ `getMovieDetail`.
- **GET /api/watchlist/intersections** ‚Äî N –≤—ã–∑–æ–≤–æ–≤ `getMovieDetail` –ø–ª—é—Å **2N –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î** (–Ω–∞ –∫–∞–∂–¥—ã–π —Ñ–∏–ª—å–º –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö `SELECT rating` ‚Äî –ø–æ user –∏ –ø–æ partner). –ü—Ä–∏ 20 –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è—Ö: 20 –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ TMDB/Redis + 40 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ PostgreSQL.

**–í–∞–∂–Ω–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –ø–æ intersections:**

SQL –¥–ª—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π —É–∂–µ –∏—Å–∫–ª—é—á–∞–µ—Ç —Ñ–∏–ª—å–º—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —É –ª—é–±–æ–≥–æ –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
`AND NOT EXISTS (SELECT 1 FROM ratings r WHERE r.user_id = $1 AND r.movie_id = w.movie_id) AND NOT EXISTS (... user_b ...)`.
–ó–Ω–∞—á–∏—Ç, –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–µ–π—Ç–∏–Ω–≥–∏ –≤—Å–µ–≥–¥–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –¢–µ–∫—É—â–∏–µ 2N –∑–∞–ø—Ä–æ—Å–æ–≤ `SELECT rating` –∏–∑–±—ã—Ç–æ—á–Ω—ã ‚Äî –æ–Ω–∏ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. **–ë—ã—Å—Ç—Ä—ã–π –≤—ã–∏–≥—Ä—ã—à: —É–±—Ä–∞—Ç—å 2N –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ intersections**  
   –í `GET /api/watchlist/intersections` –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Ä–µ–π—Ç–∏–Ω–≥–æ–≤: –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –Ω–µ—Ç –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `my_rating`, `partner_rating`, `average_rating` –≤ `null`. –≠—Ç–æ —Å—Ä–∞–∑—É —É–±–∏—Ä–∞–µ—Ç 2N round-trip –∫ –ë–î –∏ —É–ø—Ä–æ—â–∞–µ—Ç –∫–æ–¥.

2. **–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è: –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ (–µ—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è ¬´–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å —Ä–µ–π—Ç–∏–Ω–≥–∞–º–∏¬ª)**  
   –ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ª–æ–≥–∏–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—Å—è –∏ –≤ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø–æ–ø–∞–¥—É—Ç —Ñ–∏–ª—å–º—ã —Å —Ä–µ–π—Ç–∏–Ω–≥–∞–º–∏ ‚Äî –≤–º–µ—Å—Ç–æ 2 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π —Ñ–∏–ª—å–º –¥–µ–ª–∞—Ç—å –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º –¥–ª—è user –∏ –æ–¥–∏–Ω –¥–ª—è partner:  
   `SELECT movie_id, rating FROM ratings WHERE user_id = $1 AND movie_id = ANY($2)` –∏ —Ç–æ –∂–µ –¥–ª—è partnerId. –í —Ç–∞–±–ª–∏—Ü–µ `ratings` —É–∂–µ –µ—Å—Ç—å UNIQUE(user_id, movie_id), –∏–Ω–¥–µ–∫—Å –ø–æ (user_id, movie_id) —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è —Ç–∞–∫–æ–≥–æ –±–∞—Ç—á–∞.

3. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–æ–≤**  
   –•—Ä–∞–Ω–∏—Ç—å –≤ –ë–î (–∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ) `title`, `release_date`, `poster_path` –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ watchlist (–¥–∞–Ω–Ω—ã–µ –∏–∑ TMDB –Ω–∞ –º–æ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è). –¢–æ–≥–¥–∞ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –Ω–µ –Ω—É–∂–Ω—ã –≤—ã–∑–æ–≤—ã getMovieDetail ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ –ë–î. –ú–∏–Ω—É—Å: –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —É—Å—Ç–∞—Ä–µ—Ç—å; –ø–ª—é—Å: –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –∏ –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ TMDB/Redis.

4. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**  
   –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Promise.all(rows.map(...))` ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∫ Redis/TMDB, —á—Ç–æ —Ö–æ—Ä–æ—à–æ. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, p-limit) –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–∞—Ö (100+), —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å TMDB.

### 2.2 –ë—ç–∫–µ–Ω–¥: —Å–∂–∞—Ç–∏–µ –∏ –∫—ç—à HTTP

- **–°–∂–∞—Ç–∏–µ –æ—Ç–≤–µ—Ç–æ–≤** ‚Äî JSON –æ—Ç API –º–æ–∂–Ω–æ —Å–∂–∏–º–∞—Ç—å gzip/brotli. –ü–æ–¥–∫–ª—é—á–∏—Ç—å middleware `compression` –≤ Express: `npm i compression`, –∑–∞—Ç–µ–º `app.use(compression())` –¥–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤. –£–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –≤ 3‚Äì10 —Ä–∞–∑ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏ –ø–æ–∏—Å–∫–∞.
- **Cache-Control** ‚Äî –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏:
  - `GET /api/movies/search?q=...` ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π –∫—ç—à –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏–ª–∏ –ø—Ä–æ–∫—Å–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `private, max-age=60`) –∏–ª–∏ –Ω–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –∏–∑-–∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –∫—É–∫–∏/—Ç–æ–∫–µ–Ω.
  - `GET /api/movies/:id` ‚Äî –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ CDN/–ø—Ä–æ–∫—Å–∏ –º–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –ø–æ id (–Ω–∞–ø—Ä–∏–º–µ—Ä, `public, max-age=3600`), —Ç.–∫. –¥–µ—Ç–∞–ª–∏ —Ñ–∏–ª—å–º–∞ –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ.

### 2.3 –ë—ç–∫–µ–Ω–¥: –ë–î –∏ Redis

- **–ü—É–ª PostgreSQL** ‚Äî `max: 20` –≤ pool ‚Äî —Ä–∞–∑—É–º–Ω–æ. –°–≤–µ—Ä–∏—Ç—å —Å `max_connections` –≤ PostgreSQL (–æ–±—ã—á–Ω–æ 100), —á—Ç–æ–±—ã —Å—É–º–º–∞ –ø—É–ª–æ–≤ –≤—Å–µ—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–µ –ø—Ä–µ–≤—ã—à–∞–ª–∞ –ª–∏–º–∏—Ç.
- **Redis** ‚Äî –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ (singleton) ‚Äî —Ö–æ—Ä–æ—à–æ. –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ Redis –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ TMDB –ø–æ–π–¥—É—Ç –Ω–∞–ø—Ä—è–º—É—é; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–∏—Ç—å fallback (–±–µ–∑ –∫—ç—à–∞) –∏–ª–∏ –±—ã—Å—Ç—Ä—ã–π fail.
- **getConfiguration()** ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ watchlist (me, partner, intersections); —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ Redis –Ω–∞ 7 –¥–Ω–µ–π ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ TMDB –Ω–µ —Å–æ–∑–¥–∞—ë—Ç.

### 2.4 –§—Ä–æ–Ω—Ç–µ–Ω–¥

- **next/image** ‚Äî –ø–æ—Å—Ç–µ—Ä—ã –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ `PosterImage` —Å next/image, –¥–æ–º–µ–Ω `image.tmdb.org` –≤ `remotePatterns` ‚Äî —Ö–æ—Ä–æ—à–æ –¥–ª—è LCP –∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤.
- **–ö—ç—à –≤–∫–ª–∞–¥–æ–∫** ‚Äî —Å–ø–∏—Å–∫–∏ (–ú–æ–µ / –ü–∞—Ä—Ç–Ω–µ—Ä–∞ / –û–±—â–µ–µ) –Ω–µ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫ ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ —É—Ö–æ–¥–∏—Ç. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ.
- **–†–∞–∑–º–µ—Ä –±–∞–Ω–¥–ª–∞** ‚Äî First Load JS ~88‚Äì103 kB ‚Äî –ø—Ä–∏–µ–º–ª–µ–º–æ. –ü—Ä–∏ —Ä–æ—Å—Ç–µ ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç —Ç—è–∂—ë–ª—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞—Ä—Ç–æ—á–∫–∞ —Ñ–∏–ª—å–º–∞).
- **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤** ‚Äî –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/api/watchlist/me`) –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –¥–≤–∞–∂–¥—ã. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±—â–∏–π —Å–ª–æ–π (SWR/React Query) —Å –∫—ç—à–µ–º –ø–æ –∫–ª—é—á—É –∑–∞–ø—Ä–æ—Å–∞.

### 2.5 –°–≤–æ–¥–∫–∞ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –£–∑–∫–æ–µ –º–µ—Å—Ç–æ | –í–ª–∏—è–Ω–∏–µ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|-------------|---------|--------------|-----------|
| Intersections: 2N –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –∫ –ë–î | –í—ã—Å–æ–∫–æ–µ –ø—Ä–∏ N > 10 | –£–±—Ä–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã (—Ä–µ–π—Ç–∏–Ω–≥–∏ –ø–æ –ª–æ–≥–∏–∫–µ –≤—Å–µ–≥–¥–∞ null) | –í—ã—Å–æ–∫–∏–π |
| Watchlist: N –≤—ã–∑–æ–≤–æ–≤ getMovieDetail | –°—Ä–µ–¥–Ω–µ–µ (Redis —Å–º—è–≥—á–∞–µ—Ç) | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è title/poster –≤ –ë–î | –°—Ä–µ–¥–Ω–∏–π |
| –ù–µ—Ç gzip –¥–ª—è JSON | –°—Ä–µ–¥–Ω–µ–µ (—Ç—Ä–∞—Ñ–∏–∫) | Middleware `compression` | –°—Ä–µ–¥–Ω–∏–π |
| –ù–µ—Ç Cache-Control –¥–ª—è movies | –ù–∏–∑–∫–æ–µ | –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è /api/movies/:id (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) | –ù–∏–∑–∫–∏–π |

---

## 3. –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

### –°–¥–µ–ª–∞–Ω–æ

- **Backend:**  
  - `health.test.ts` ‚Äî GET /api/health  
  - `auth.validation.test.ts` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è register/login (400)  
  - `auth.401.test.ts` ‚Äî 401 –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –∏ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è /api/pairs, /api/watchlist/me (GET/POST)  
  - `movies.test.ts` ‚Äî –ø–æ–∏—Å–∫ –±–µ–∑ q (–ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç), –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id (400)  
  - `errorHandler.test.ts` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫  
  - –í —Ä–æ—É—Ç–µ movies: –ø–µ—Ä–µ–¥–∞—á–∞ `AppError` –≤ next(e), —á—Ç–æ–±—ã 400 –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–ª—Å—è –≤ 502  

- **Web:**  
  - `api.test.ts` ‚Äî getApiUrl, getErrorMessage  

- **CI (GitHub Actions):** –≤ workflow –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è `npm run test` –¥–ª—è backend –∏ web –±–µ–∑ –ë–î/Redis; —Ç–µ—Å—Ç—ã unit/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç.

### –û—Å—Ç–∞—ë—Ç—Å—è (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

1. **Backend (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î –≤ CI)**  
   –£—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: register ‚Üí login ‚Üí —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ.  
   –ü–∞—Ä—ã: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—ã, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ –∫–æ–¥—É, –≤—ã—Ö–æ–¥; 404 –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–∞—Ä—ã –¥–ª—è partner/intersections.  
   Watchlist: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ/–æ—Ü–µ–Ω–∫–∞; –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

2. **Backend –±–µ–∑ –ë–î**  
   –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å pool (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å in-memory SQLite –¥–ª—è —Ç–µ—Å—Ç–æ–≤) –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø–∞—Ä –∏ watchlist.

3. **Web**  
   –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã —É—Ç–∏–ª–∏—Ç –∏ —Ö—É–∫–æ–≤.  
   –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (React Testing Library), E2E (Playwright/Cypress).

4. **CI**  
   –°–µ–π—á–∞—Å —Ç–µ—Å—Ç—ã backend –Ω–µ —Ç—Ä–µ–±—É—é—Ç –ë–î (health, validation, 401, movies –±–µ–∑ TMDB). –î–ª—è —Ç–µ—Å—Ç–æ–≤ —Å –ë–î ‚Äî —Å–µ—Ä–≤–∏—Å PostgreSQL –≤ GitHub Actions –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ DATABASE_URL, JWT_SECRET.

---

## 4. –ö—Ä–∞—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç

| –û–±–ª–∞—Å—Ç—å | –î–µ–π—Å—Ç–≤–∏–µ | –°—Ç–∞—Ç—É—Å |
|---------|----------|--------|
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | Rate limit, helmet, JWT_SECRET –∏ CORS –≤ –ø—Ä–æ–¥–µ | ‚úÖ Rate limit –∏ helmet —Å–¥–µ–ª–∞–Ω—ã; –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –∏ CORS –≤ –ø—Ä–æ–¥–µ |
| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | next/image, –∫—ç—à –≤–∫–ª–∞–¥–æ–∫ | ‚úÖ –°–¥–µ–ª–∞–Ω–æ |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –£–±—Ä–∞—Ç—å 2N –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ intersections, compression, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è | üî≤ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ: —É–±—Ä–∞—Ç—å 2N –∏ compression |
| –¢–µ—Å—Ç—ã backend | 401, movies (—Ñ–æ—Ä–º–∞—Ç, invalid id) | ‚úÖ –°–¥–µ–ª–∞–Ω–æ; –æ—Å—Ç–∞—ë—Ç—Å—è: pairs, watchlist, auth success (–ø—Ä–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î) |
| –¢–µ—Å—Ç—ã frontend | –£—Ç–∏–ª–∏—Ç—ã, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ E2E | –û—Å—Ç–∞—ë—Ç—Å—è |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫, –º–µ—Ç—Ä–∏–∫–∏, –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î | –û—Å—Ç–∞—ë—Ç—Å—è |

---

## 5. –ù–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞)

1. **–£–±—Ä–∞—Ç—å 2N –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ GET /api/watchlist/intersections**  
   –ü–æ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ SQL –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å–º—ã –±–µ–∑ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ —É –æ–±–æ–∏—Ö. –ù–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å `SELECT rating` –≤ —Ü–∏–∫–ª–µ ‚Äî –∑–∞–¥–∞—Ç—å `my_rating`, `partner_rating`, `average_rating` –∫–∞–∫ `null`. –°–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î –∏ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞.

2. **–î–æ–±–∞–≤–∏—Ç—å middleware `compression`** –≤ Express –¥–ª—è gzip/brotli –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî —É–º–µ–Ω—å—à–∏—Ç —Ç—Ä–∞—Ñ–∏–∫ –∏ —É—Å–∫–æ—Ä–∏—Ç –æ—Ç–¥–∞—á—É –±–æ–ª—å—à–∏—Ö JSON (—Å–ø–∏—Å–∫–∏, –ø–æ–∏—Å–∫).

3. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:** –≤ —Ç–∞–±–ª–∏—Ü—É watchlist (–∏–ª–∏ –∫—ç—à) –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å title, release_date, poster_path –∏–∑ TMDB, —á—Ç–æ–±—ã —Å–ø–∏—Å–∫–∏ –æ—Ç–¥–∞–≤–∞—Ç—å –±–µ–∑ N –≤—ã–∑–æ–≤–æ–≤ getMovieDetail; –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–ª–∏ TTL.

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ø—Ä–æ–¥–µ:** `max` –≤ pg.Pool –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π –∑–∞–ø–∞—Å `max_connections` –≤ PostgreSQL —Å —É—á—ë—Ç–æ–º –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ middleware errorHandler) –≤ —Ñ–∞–π–ª –∏–ª–∏ —Å–µ—Ä–≤–∏—Å, —á—Ç–æ–±—ã —É–ø—Ä–æ—Å—Ç–∏—Ç—å —Ä–∞–∑–±–æ—Ä –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤.

6. **–ò–Ω–¥–µ–∫—Å—ã –ë–î:** –≤ `schema.sql` —É–∂–µ –µ—Å—Ç—å `idx_ratings_user`, `idx_ratings_movie` –∏ UNIQUE(user_id, movie_id) –≤ ratings ‚Äî –¥–ª—è –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤–∏–¥–∞ `WHERE user_id = $1 AND movie_id = ANY($2)` —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.
