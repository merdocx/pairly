# Рекомендации: оптимизация, безопасность, тесты

**Дата:** 28.01.2026  
**Версия проекта:** 0.3.0

---

## 1. Безопасность

### Критично

- **JWT_SECRET в production**  
  В коде есть fallback `'dev-secret-change-in-production'`. В проде обязательно задавать свой длинный случайный `JWT_SECRET` в `.env` (уже делается на сервере — проверить, что нигде не подхватывается дефолт).

- **Rate limiting**  
  Нет ограничения частоты запросов. Риски:
  - перебор паролей на `/api/auth/login`;
  - массовая регистрация на `/api/auth/register`;
  - нагрузка на TMDB и ваш бэкенд через `/api/movies/search`.  
  **Рекомендация:** подключить `express-rate-limit` (отдельные лимиты для auth и для API, строже для login/register).

- **Заголовки безопасности**  
  Не заданы безопасные HTTP-заголовки.  
  **Рекомендация:** использовать `helmet` в Express (`app.use(helmet())`) с настройкой под CORS и при необходимости Content-Security-Policy.

### Желательно

- **Токен в localStorage**  
  JWT хранится в `localStorage` — при XSS его можно украсть. Более безопасный вариант — httpOnly cookie с флагом secure в HTTPS (потребует изменений на бэкенде и фронте).

- **CORS**  
  Сейчас `WEB_ORIGIN` задаётся вручную. Убедиться, что в проде нет `*` и перечислены только нужные домены.

- **Валидация входных данных**  
  В auth используется Zod — хорошо. В других роутах (например, `movieId`, `id`) проверки есть, но стоит единообразно валидировать все query/params/body (Zod или аналог) и возвращать 400 при неверном формате.

---

## 2. Оптимизация

### Бэкенд

- **Кэш TMDB**  
  Redis уже используется для поиска и деталей — хорошо. TTL заданы (1 ч поиск, 24 ч фильм/сериал) — ок.

- **БД**  
  Индексы по `email`, `pairs.code`, `watchlist(user_id, movie_id)`, `ratings(user_id, movie_id)` есть — запросы по ним должны быть быстрыми. При росте данных можно добавить мониторинг медленных запросов (pg_stat_statements или логирование времени выполнения).

- **Пул соединений PostgreSQL**  
  Проверить, что размер пула (по умолчанию в `pg`) достаточен под нагрузку и не слишком большой относительно `max_connections` в PostgreSQL.

### Фронтенд

- **Изображения**  
  Используется `<img>` для постеров TMDB. ESLint предупреждает: лучше использовать `next/image` (оптимизация, lazy load, современные форматы). Учесть, что домен `image.tmdb.org` нужно добавить в `images.domains` в `next.config.js`.

- **Размер бандла**  
  First Load JS ~88–97 kB — нормально. При росте приложения имеет смысл следить за динамическим импортом тяжёлых страниц/компонентов.

- **API-запросы**  
  На главной три вкладки (Мое / Партнера / Общее) — каждая при переключении дергает API. Можно кэшировать ответы на клиенте (React Query, SWR или свой кэш по `tab`), чтобы не запрашивать заново при каждом переключении.

---

## 3. Покрытие тестами

### Сейчас

- **Backend:**  
  - `health.test.ts` — GET /api/health  
  - `auth.validation.test.ts` — валидация register/login (400 при неверных данных)  
  - `errorHandler.test.ts` — обработка ошибок  
  Нет тестов на: пары (create/join/leave), watchlist (CRUD, пересечения), movies (search, detail), успешный login/register и защищённые роуты.

- **Web:**  
  - `api.test.ts` — минимальные проверки `getApiUrl`, `getErrorMessage`  
  Нет тестов компонентов и страниц.

### Рекомендации

1. **Backend (приоритет)**  
   - Интеграционные тесты для успешного сценария: register → login → токен в заголовке.  
   - Тесты пар: создание пары, присоединение по коду, выход; проверка, что без пары нельзя получить список партнёра/пересечений.  
   - Тесты watchlist: добавление/удаление/оценка от имени пользователя; проверка, что пользователь видит только свои элементы и партнёра (где предусмотрено).  
   - Тесты movies: мок TMDB или реальный запрос к TMDB (с лимитом), проверка формата ответа search и detail (movie + tv).  
   - Проверка 401 на защищённых роутах без токена и с неверным токеном.

2. **Web**  
   - Юнит-тесты для утилит и хуков (например, логика сортировки, форматирование).  
   - При необходимости — компонентные тесты (React Testing Library) для критичных экранов (форма входа, список, карточка фильма).  
   - E2E (Playwright/Cypress) — опционально, для сценариев: регистрация → вход → поиск → добавление в список.

3. **CI**  
   В CI уже есть lint, build, test для backend и web. Для backend тестов при необходимости поднимать PostgreSQL (и при желании Redis) в GitHub Actions (сервис-контейнер или docker-compose) и задавать переменные окружения (DATABASE_URL, JWT_SECRET, TMDB_API_KEY для моков или реального API).

---

## 4. Краткий чек-лист

| Область           | Действие | Статус |
|-------------------|----------|--------|
| Безопасность      | Включить rate limit (auth + API), helmet, проверить JWT_SECRET и CORS в проде | ✅ Сделано: rate limit (auth 20/15мин, API 120/мин), helmet |
| Оптимизация       | Рассмотреть next/image для постеров, кэш ответов API на клиенте для вкладок | ✅ Сделано: PosterImage (next/image), вкладки не размонтируются — кэш по tab |
| Тесты backend     | Добавить тесты для auth (успех), pairs, watchlist, movies, 401 | ✅ Сделано: auth.401.test.ts (401 без/с неверным токеном), movies.test.ts (search без q, invalid id) |
| Тесты frontend    | Расширить тесты api/утилит, при необходимости — компоненты и E2E | Остаётся |
| Мониторинг (позже)| Логирование ошибок, метрики (опционально), проверка медленных запросов к БД | Остаётся |
