# Фильтрация уже отображаемых фильмов

**Цель:** фильтровать и сортировать только те карточки, которые уже загружены и отображаются на странице. Без изменений API и без подгрузки новых данных при смене фильтра.

---

## 1. Принцип

- **Источник данных не меняется:** списки «Моё», «Партнёра», «Общее» загружаются одним запросом, как сейчас; поиск — по текущему запросу и уже подгруженным страницам.
- **Фильтрация и сортировка** выполняются на фронте по массиву уже отображённых элементов (в памяти).
- **Результат:** пользователь сужает список карточек и меняет порядок без новых запросов к API.

---

## 2. Какие фильтры по страницам

| Фильтр | Моё | Партнёра | Общее | Поиск |
|--------|-----|----------|--------|-------|
| **Тип: всё / фильмы / сериалы** | ✓ | ✓ | ✓ | ✓ |
| **Просмотрено: всё / да / нет** | ✓ | — | — | — |
| **Сортировка** | ✓ (дата, оценка, название, год) | ✓ (название, год, дата) | ✓ (название, год) | ✓ (в списке / по году) |
| **Год (диапазон или десятилетие)** | ✓ | ✓ | ✓ | ✓ |
| **Жанр** | ✓ | ✓ | ✓ | — (в поиске жанра нет в ответе) |

Данные для фильтров берутся из полей карточек: `media_type`, `release_date`, `genre`, `rating` (просмотрено = есть оценка).

---

## 3. Реализация логики

- **Один слой фильтрации:** из полного массива `items` (или `results` на поиске) получаем отфильтрованный массив по выбранным условиям, затем применяем сортировку.
- **Условия:**
  - **Тип:** `media_type === 'movie'` / `'tv'` или без фильтра.
  - **Просмотрено (только «Моё»):** `rating != null` / `rating == null` или без фильтра.
  - **Год:** из `release_date` извлекаем 4 цифры, сравниваем с диапазоном (например «2020–2024» или пресет «2020-е»).
  - **Жанр:** строка `genre` в watchlist — «Жанр1, Жанр2»; фильтр «содержит выбранный жанр» (например «Комедия»).
- **Сортировка:** по полю (название, год, дата добавления, оценка) и направлению (по возрастанию/убыванию). Для названия — `localeCompare('ru')`.
- **Список жанров для селекта:** уникальные значения, полученные из всех `items`: разбить `genre` по запятой, trim, убрать пустые, отсортировать.

Фильтры и сортировку можно вынести в хук `useFilteredItems(items, { mediaType, watched, yearFrom, yearTo, genre, sortBy, sortOrder })`, который возвращает массив для рендера.

---

## 4. Дизайн: кнопка + модалка

### 4.1 Кнопка

- **Размещение:** в **нижнем правом углу**, **над нижним меню** (bottom nav). Прозрачный фон (или полупрозрачный), иконка фильтра (воронка).
- **Размер:** ~44–48 px по касанию. Отступ снизу: `calc(56px + env(safe-area-inset-bottom) + 8px)` или аналог (высота bottom nav + зазор). Справа — 16 px от края. `position: fixed`, `z-index` выше сетки, но ниже модалки.
- **Индикация активных фильтров:** бейдж на кнопке с числом активных фильтров или лёгкая подсветка кнопки, если включён хотя бы один фильтр.

### 4.2 Модалка

- **По тапу** на кнопку открывается **модалка** с заголовком «Фильтры» и всеми опциями по секциям: Тип (всё / фильмы / сериалы), Просмотрено (только на «Моё»), Год, Жанр, Сортировка. Внизу модалки — кнопки «Сбросить» и «Готово» (закрывает модалку и применяет фильтры).
- **Реализация:** по аналогии с уже существующими модалками (overlay + карточка по центру или снизу). Контент — форма с радио/чекбоксами по секциям. Состояние фильтров в state (и при желании в URL).

### 4.3 Главная и поиск

- **Главная (Моё, Партнёра, Общее):** одна и та же кнопка в углу на всех трёх вкладках; в модалке — полный набор фильтров (на «Партнёра» и «Общее» без блока «Просмотрено»).
- **Поиск:** та же кнопка в углу; в модалке только «Тип» и «Сортировка» (на поиске без жанра и без «Просмотрено»; год при желании — по уже загруженным карточкам).

### 4.4 Пустое состояние

- Если после применения фильтров ни одна карточка не подходит: вместо пустой сетки показать текст «Нет фильмов, подходящих под выбранные фильтры» и кнопку «Сбросить фильтры». В модалке — кнопка «Сбросить» сбрасывает все фильтры.

### 4.5 Адаптив

- Кнопка всегда в одном месте. Модалка на мобиле может открываться снизу (как bottom sheet) или по центру — как остальные модалки в приложении. Убедиться, что кнопка не перекрывает последний ряд карточек: отступ снизу строго над bottom nav.

---

## 5. URL и состояние

- Выбранные фильтры и сортировку можно записывать в URL через `searchParams` (например `?tab=me&type=movie&watched=no&sort=title&order=asc`), чтобы:
  - при переключении табов и возврате назад состояние фильтров восстанавливалось;
  - можно было поделиться ссылкой на отфильтрованный вид.
- Значения по умолчанию: тип «всё», просмотрено «всё», год без ограничений, жанр «все», сортировка как сейчас (например по дате добавления для «Моё», по названию для «Партнёра» и «Общее»).

---

## 6. Порядок внедрения

1. **Общая логика:** хук или утилита `filterAndSort(items, filters)`; подготовка списка жанров из `items`.
2. **Кнопка в углу:** фиксированная кнопка с иконкой фильтра над bottom nav; по тапу — открытие модалки.
3. **Модалка фильтров:** заголовок «Фильтры», секции Тип, Просмотрено (для «Моё»), Год, Жанр, Сортировка; кнопки «Сбросить» и «Готово». Применение к массиву `items` каждой вкладки главной.
4. **Сохранение состояния в URL** (опционально).
5. **Поиск:** та же кнопка + модалка с «Тип» и «Сортировка»; фильтрация по уже загруженным `results`.
6. **Пустое состояние и сброс:** сообщение «Нет фильмов…» и кнопка «Сбросить фильтры»; в модалке — кнопка «Сбросить».

---

## 7. Итог

- Фильтрация **только по уже отображаемым** карточкам, без новых запросов к API.
- **UI:** кнопка с прозрачным фоном в нижнем правом углу над нижним меню; по нажатию — модалка со всеми фильтрами и кнопками «Сбросить» / «Готово». Опционально: бейдж на кнопке с числом активных фильтров.
- Логика на фронте (фильтр + сортировка по полям карточек); при желании позже часть можно перенести в API — текущая реализация от этого не зависит.
